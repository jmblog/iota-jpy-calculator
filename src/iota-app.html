<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-layout.html">

<dom-module id="iota-app">
  <template>
    <style include="app-grid-style">
      :host {
        display: block;
        position: relative;
        min-height: 100vh;
        --app-primary-color: #303030;
        --app-secondary-color: #808b92;
        --app-accent-color: #009fff;
        --app-border-color: #e5e5e5;
        --paper-button-ink-color: var(--app-accent-color);
        --paper-icon-button-ink-color: var(--app-accent-color);
        --paper-spinner-color: var(--app-accent-color);
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        color: var(--app-primary-color);
      }

      app-toolbar {
        height: 98px;
        font-size: 24px;
        font-weight: 600;
        letter-spacing: 0.1em;
        border-bottom: 1px solid var(--app-border-color);
      }

      .content {
        padding: 42px 16px;
      }

      .container {
        display: flex;
        justify-content: center;
        margin: 0 auto;
      }

      .ticker {
        display: flex;
        align-items: center;
        margin-bottom: 42px;
      }

      @media (max-width: 767px) {
        .content {
          padding: 24px;
        }

        .container {
          width: 100%;
          padding: 0;
        }

        .ticker {
          flex-direction: column;
          align-items: flex-start;
          min-height: 220px;
        }
      }
    </style>
    <app-toolbar>
      <div class="container">
        <div main-title>IOTA/JPY Calculator</div>
      </div>
    </app-toolbar>
    <div class="content">
      <div class="container">
        <div class="ticker">
          <iota-ticker price="[[iota_jpy]]"></iota-ticker>
          <div>
            <iota-ticker-secondary price="[[btc_jpy]]" unit="JPY/BTC" format="0,0" by="bitFlyer"></iota-ticker-secondary>
            <iota-ticker-secondary price="[[iota_btc]]" unit="BTC/Mi" by="Bitfinex"></iota-ticker-secondary>
          </div>
        </div>
      </div>
      <div class="container">
        <iota-calculator unit-price="[[iota_jpy]]" calculated-currency="Â¥"></iota-calculator>
      </div>
    </div>
  </template>

  <script>
    class IotaApp extends Polymer.Element {
      static get is() { return 'iota-app'; }

      constructor() {
        super()
      }

      static get properties() {
        return {
          btc_jpy: {
            type: Number,
            value: 0,
            notify: true,
          },
          iota_btc: {
            type: Number,
            value: 0,
            notify: true,
          },
          iota_jpy: {
            type: Number,
            value: 0,
            computed: 'computeIotaJpy(btc_jpy, iota_btc)'
          },
        }
      }

      computeIotaJpy(btc_jpy, iota_btc) {
        return btc_jpy * iota_btc;
      }

      ready() {
        super.ready();
        this._subscribeBitFlyerLighteningTicker();
        this._subscribeBitfinexTicker();
        // Custom elements polyfill safe way to indicate an element has been upgraded.
        this.removeAttribute('unresolved');
        this._ensureLazyLoaded();
      }

      _ensureLazyLoaded() {
        // load lazy resources after render and set `loadComplete` when done.
        if (!this.loadComplete) {
          Polymer.RenderStatus.afterNextRender(this, () => {
            Polymer.importHref(this.resolveUrl('lazy-resources.html'), () => {
              // Register service worker if supported.
              if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js', { scope: '/' });
              }
              this.loadComplete = true;
            });
          });
        }
      }

      _subscribeBitFlyerLighteningTicker() {
        const pubnub = new PubNub({
          subscribeKey: 'sub-c-52a9ab50-291b-11e5-baaa-0619f8945a4f',
        });
        pubnub.addListener({
          message: message => {
            this.btc_jpy = message.message.best_ask;
          },
        });
        pubnub.subscribe({
          channels: ['lightning_ticker_BTC_JPY'],
        });
      }

      _subscribeBitfinexTicker() {
        const wss = new WebSocket('wss://api.bitfinex.com/ws');
        wss.onopen = () => {
          wss.send(
            JSON.stringify({
              event: 'subscribe',
              channel: 'ticker',
              pair: 'IOTBTC',
            }),
          );
        };

        // Log errors
        wss.onerror = error => {
          console.log('WebSocket Error ' + error);
        };

        // Log messages from the server
        wss.onmessage = e => {
          const data = JSON.parse(e.data);
          if (!Array.isArray(data)) {
            return;
          }
          if (data[1] === 'hb') {
            return;
          }
          this.iota_btc = data[1];
        };
      }
    }

    window.customElements.define(IotaApp.is, IotaApp);
  </script>

</dom-module>
